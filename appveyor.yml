version: 1.0.{build}
skip_tags: true
os: Windows Server 2012 R2
clone_depth: 8
clone_folder: C:\w\
environment:
  BINTRAY_APIKEY:
    secure: FUQVzdqjaAvLYH/yTdL1rdtrVcAheHbK4YUvNNpvArR09vfkkuAk+8ntrg2MRYa2
  BINTRAY_USER:
    secure: jfLq1ApyVLNouxv07skhrg==
install:
# Using zlib headers and static libraries bundled with mingw-w64
#- set VER_ZLIB=1.2.8
- set VER_OPENSSL=1.0.2d
- set VER_LIBSSH2=1.6.0
- set VER_CURL=7.45.0
# PATH must be reconfigured to use short name for the sh.exe location, otherwise the OpenSSL build process fails
- set PATH=C:\PROGRA~2\Git\bin;%PATH%
- curl -fsS -L --proto-redir =https https://github.com/git-for-windows/git/releases/download/v2.6.1.windows.1/PortableGit-2.6.1-64-bit.7z.exe -o git.7z
- openssl dgst -sha256 git.7z | findstr /i /c:"5118b86924fd586caa1f31ebda2d71ed4f7c18ba6c0df4a71f06b90d625837e8"
- 7z x -y -oC:\git\ git.7z > nul
- set PATH=C:\git\cmd;C:\git\usr\bin;C:\git\mingw64\bin;%PATH%
# Long URL: "https://www.mirrorservice.org/sites/dl.sourceforge.net/pub/sourceforge/m/mi/mingw-w64/Toolchains targetting Win64/Personal Builds/mingw-builds/5.2.0/threads-posix/sjlj/x86_64-5.2.0-release-posix-sjlj-rt_v4-rev0.7z"
- curl -fsS -L --proto-redir =https https://goo.gl/mQF6vO -o mingw.7z
- openssl dgst -sha256 mingw.7z | findstr /i /c:"c0536c55a1d12882987afd0a9be377413eaf6cee105e921c949899fa9b308b35"
# Will unpack into C:\w\mingw64
- 7z x -y -oC:\w\ mingw.7z > nul
#- curl -fsS -L --proto-redir =https https://github.com/madler/zlib/archive/v%VER_ZLIB%.tar.gz -o zip.tar.gz
#- openssl dgst -sha256 zip.tar.gz | findstr /i /c:"e380bd1bdb6447508beaa50efc653fe45f4edc1dafe11a251ae093e0ee97db9a"
#- tar -zxvf zip.tar.gz > nul 2>&1
#- del zip.tar.gz
#- move zlib-%VER_ZLIB% zlib
# Use http:// here for old curl.exe (curl 7.30.0 (i386-pc-win32) libcurl/7.30.0 OpenSSL/0.9.8{ zlib/1.2.7) otherwise it will fail.
- curl -fsS https://www.openssl.org/source/openssl-%VER_OPENSSL%.tar.gz -o openssl.tar.gz
- openssl dgst -sha256 openssl.tar.gz | findstr /i /c:"671c36487785628a703374c652ad2cebea45fa920ae5681515df25d9f2c9a8c8"
- tar -zxvf openssl.tar.gz > nul 2>&1
- del openssl.tar.gz
- move openssl-%VER_OPENSSL% openssl
- dos2unix openssl.diff
- cd openssl
# Using 'sed' for now
#- patch -p0 -i ../openssl.diff
- cd ..
- curl -fsS -L --proto-redir =https https://github.com/libssh2/libssh2/releases/download/libssh2-%VER_LIBSSH2%/libssh2-%VER_LIBSSH2%.tar.gz -o libssh2.tar.gz
- openssl dgst -sha256 libssh2.tar.gz | findstr /i /c:"5a202943a34a1d82a1c31f74094f2453c207bf9936093867f41414968c8e8215"
- tar -zxvf libssh2.tar.gz > nul 2>&1
- del libssh2.tar.gz
- move libssh2-%VER_LIBSSH2% libssh2
- dos2unix libssh2.diff
- cd libssh2
- patch -p0 -i ../libssh2.diff
- cd ..
- curl -fsS -L --proto-redir =https https://github.com/bagder/curl/releases/download/curl-%VER_CURL:.=_%/curl-%VER_CURL%.tar.gz -o curl.tar.gz
- openssl dgst -sha256 curl.tar.gz | findstr /i /c:"02c78c8060d587422e2826f622c729189b56084bba365140f13af3d402b6cb6b"
- tar -zxvf curl.tar.gz > nul 2>&1
- del curl.tar.gz
- move curl-%VER_CURL% curl
- dos2unix curl.diff
- cd curl
- patch -p0 -i ../curl.diff
- cd ..
- reg add "HKCU\Control Panel\International" /v sShortDate /t REG_SZ /d "yyyy-MM-dd" /f
- reg add "HKCU\Control Panel\International" /v sShortTime /t REG_SZ /d "HH:mm" /f
# From https://www.mirrorservice.org/sites/dl.sourceforge.net/pub/sourceforge/m/mi/mingw-w64-dgn/mingw-w64/mingw-w64-bin-x86_64-20150801.7z
- copy /y mingw32-make.exe C:\w\mingw64\bin\mingw32-make.exe
build_script:
- set PATH=C:\w\mingw64\bin;%PATH%
- set CPU=win32
- mk-openssl.bat %VER_OPENSSL% %CPU%
- mk-libssh2.bat %VER_LIBSSH2% %CPU%
- mk-curl.bat    %VER_CURL%    %CPU%
- set CPU=win64
- mk-openssl.bat %VER_OPENSSL% %CPU%
- mk-libssh2.bat %VER_LIBSSH2% %CPU%
- mk-curl.bat    %VER_CURL%    %CPU%
- type hashes.txt
